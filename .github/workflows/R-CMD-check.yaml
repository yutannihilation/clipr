# Workflow derived from https://github.com/r-lib/actions/tree/master/examples
# Need help debugging build failures? Start at https://github.com/r-lib/actions#where-to-find-help
on:
  push:
    branches: [main, actions]
  pull_request:
    branches: [main, actions]

name: R-CMD-check

jobs:
  R-CMD-check:
    runs-on: ${{ matrix.config.os }}

    name: ${{ matrix.config.os }} (${{ matrix.config.r }}) (Clip? ${{ matrix.config.allow_clip }} Type? ${{ matrix.config.clip_type }})

    strategy:
      fail-fast: false
      matrix:
        config:
          - { os: macOS-latest, r: 'release', allow_clip: TRUE }
          - { os: windows-latest, r: 'release', allow_clip: TRUE }
          - {
              os: ubuntu-latest,
              r: 'devel',
              http-user-agent: 'release',
              allow_clip: TRUE,
              clip_type: xclip,
            }
          - {
              os: ubuntu-latest,
              r: 'release',
              allow_clip: TRUE,
              clip_type: xclip,
            }
          - {
              os: ubuntu-latest,
              r: 'release',
              allow_clip: TRUE,
              clip_type: xsel,
            }
          - { os: ubuntu-latest, r: 'release', clip_type: xsel }
          - {
              os: ubuntu-latest,
              r: 'release',
              allow_clip: TRUE,
              clip_type: none,
            }
          - {
              os: ubuntu-latest,
              r: 'release',
              allow_clip: TRUE,
              clip_type: nodisplay,
            }
          - {
              os: ubuntu-latest,
              r: 'oldrel-1',
              allow_clip: TRUE,
              clip_type: xclip,
            }
          - {
              os: ubuntu-latest,
              r: 'release',
              allow_clip: TRUE,
              clip_type: wayland,
            }

    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
      R_KEEP_PKG_SOURCE: yes

    steps:
      - uses: actions/checkout@v2

      - name: Install and run XVFB
        if: ${{ matrix.config.clip_type == 'xclip' || matrix.config.clip_type == 'xsel' }}
        run: |
          sudo apt-get install -y xvfb
          sudo /usr/bin/Xvfb :99.0 -screen 0 1280x1024x24 &
          sleep 3

      - name: Install xclip
        if: ${{ matrix.config.clip_type == 'xclip' }}
        run: |
          sudo apt-get install -y xclip
          # Initialize xclip
          uptime | xclip -i -sel p -f | xclip -i -sel c
          xclip -o -sel clipboard
        env:
          DISPLAY: ':99.0'

      - name: Install xclip (nodisplay)
        if: ${{ matrix.config.clip_type == 'nodisplay' }}
        run: |
          sudo apt-get install -y xclip

      - name: Install xsel
        if: ${{ matrix.config.clip_type == 'xsel' }}
        run: |
          sudo apt-get install -y xsel

      - name: Install wayland
        if: ${{ matrix.config.clip_type == 'wayland' }}
        run: |
          export XDG_RUNTIME_DIR=$GITHUB_WORKSPACE/../xdg
          mkdir $XDG_RUNTIME_DIR
          chown $USER $XDG_RUNTIME_DIR
          chmod 0700 $XDG_RUNTIME_DIR
          sudo apt-get purge x11-*
          sudo apt-get install weston meson libwayland-dev
          ls -la /usr/lib/x86_64-linux-gnu/libweston-8
          weston -B headless-backend.so --require-input=false
          cd $GITHUB_WORKSPACE/..
          git clone https://github.com/bugaevc/wl-clipboard.git
          cd wl-clipboard
          meson build
          cd build/
          sudo ninja install
          wl-copy --primary
          ls -la $XDG_RUNTIME_DIR
          wl-paste --primary
          cd $GITHUB_WORKSPACE
        env:
          DISPLAY: ':99.0'
          WLR_BACKENDS: headless
          WLR_LIBINPUT_NO_DEVICES: 1
          WAYLAND_DISPLAY: wayland-1

      - uses: r-lib/actions/setup-pandoc@v1

      - uses: r-lib/actions/setup-r@v1
        with:
          r-version: ${{ matrix.config.r }}
          http-user-agent: ${{ matrix.config.http-user-agent }}
          use-public-rspm: true

      - uses: r-lib/actions/setup-r-dependencies@v1
        with:
          extra-packages: rcmdcheck

      - uses: r-lib/actions/check-r-package@v1
        if: ${{ matrix.config.clip_type != 'nodisplay' }}
        env:
          ALLOW_CLIP: ${{ matrix.config.allow_clip }}
          CLIP_TYPE: ${{ matrix.config.clip_type }}
          DISPLAY: ':99.0'
          WAYLAND_DISPLAY: wayland-1

      - uses: r-lib/actions/check-r-package@v1
        if: ${{ matrix.config.clip_type == 'nodisplay' }}
        env:
          ALLOW_CLIP: ${{ matrix.config.allow_clip }}
          CLIP_TYPE: ${{ matrix.config.clip_type }}
